# プログラム構造 - 家計簿スマホ入力PWA

## 1. 全体構成

本アプリケーションは、ビルドツールに **Vite** を採用し、UIフレームワークとして **Svelte 5**、言語に **TypeScript** を使用した、モダンなWeb標準ベースのシングルページアプリケーション（SPA）である。
PWA（Progressive Web App）として動作し、オフラインでの利用やモバイル端末のホーム画面へのインストールに対応している。

## 2. ディレクトリ構造

プロジェクトの主要なファイルとディレクトリの役割は以下の通り。

``` text
household-pwa/
├── .github/workflows/deploy.yml   # GitHub Actionsによる自動デプロイ定義
├── public/                        # PWA用アイコンなどの静的ファイル
├── src/
│   ├── app.css                    # グローバルCSS、テーマ変数定義
│   ├── App.svelte                 # アプリケーションのルートコンポーネント
│   ├── main.ts                    # アプリケーションのエントリーポイント
│   └── lib/
│       ├── components/            # UIを構成するSvelteコンポーネント群
│       │   ├── Input.svelte       # 入力画面
│       │   ├── List.svelte        # 一覧画面
│       │   └── Export.svelte      # 出力画面
│       ├── constants/             # 定数・マスターデータ
│       │   ├── masters.ts         # データモデル(Interface)とマスターデータ定義
│       │   └── texts.ts           # UIに表示するテキスト集約
│       ├── db/
│       │   └── indexeddb.ts       # IndexedDBとのデータ送受信ロジックをカプセル化
│       ├── services/
│       │   └── settings.svelte.ts # テーマ管理など、横断的な状態管理サービス
│       └── utils/
│           └── formatters.ts      # 日付や通貨のフォーマットなど補助関数
├── package.json                   # プロジェクト定義と依存ライブラリ
└── vite.config.ts                 # Vite（ビルド・開発サーバー）設定
```

## 3. アーキテクチャとデータフロー

### 3.1. コンポーネント構造

- **`App.svelte`** がアプリケーション全体の親（ルート）コンポーネントとして機能する。
- `App.svelte` は、現在のタブ状態（`input`, `list`, `export`）に応じて、`lib/components/` 以下の **`Input.svelte`**, **`List.svelte`**, **`Export.svelte`** のいずれか一つを動的に描画する。
- コンポーネント間の連携は、Svelteのイベントディスパッチ（子→親）とプロパティ（親→子）を用いて行われる。
  - 例: `List.svelte` で編集ボタンが押されると`onedit`イベントが発生し、`App.svelte`がそれを捕捉して`Input.svelte`に編集対象データを渡して表示を切り替える。

### 3.2. 状態管理

本アプリケーションの状態管理は、その役割に応じて複数の仕組みを使い分けている。

- **UI状態 (Local State)**: 現在アクティブなタブ、トースト通知の表示/非表示といった、一時的で単一コンポーネントに閉じる状態は、`App.svelte`内のSvelte 5の `$state` を使用してリアクティブに管理される。
- **永続データ (IndexedDB)**: 取引データ（`Transaction`）は、ブラウザの永続ストレージであるIndexedDBに保存される。`lib/db/indexeddb.ts` がこのデータベースとのすべてのやり取りを抽象化し、他のコンポーネントは `addTransaction` や `getAllTransactions` といった関数を呼び出すだけで済む。
- **設定・キャッシュ (Local Storage)**: テーマ設定（ダーク/ライト）や、入力補助のための前回選択項目などの軽量なデータは、より手軽な`localStorage`に保存される。これらの管理ロジックは `lib/services/settings.svelte.ts` に集約されている。

### 3.3. データフローの例 (新規取引の追加)

1. **ユーザー操作**: ユーザーが `Input.svelte` で情報を入力し、「保存」ボタンをクリックする。
2. **イベント発火**: `Input.svelte` は `onsave` イベントを発火させる。
3. **イベント捕捉と処理**: `App.svelte` が `onsave` イベントを捕捉し、`handleSave` 関数を実行する。
4. **DB書き込み**: `handleSave` 関数内で `lib/db/indexeddb.ts` に定義された `addTransaction` が呼び出され、入力データがIndexedDBに非同期で書き込まれる。
5. **UIフィードバック**:
    - `addTransaction` の処理が成功すると、`App.svelte` はトースト通知を表示する。
    - 同時に、`List.svelte` コンポーネントの `loadTransactions` メソッドを呼び出し、一覧表示を最新の状態に更新する。

## 4. 主要モジュール解説

- **`main.ts`**: アプリケーションの起動点。`body` 要素に `App.svelte` コンポーネントをマウント（描画）する。
- **`App.svelte`**: アプリ全体のレイアウト、主要コンポーネントの動的切り替え、コンポーネント間のイベント調整役を担う、アプリケーションの中枢。
- **`lib/db/indexeddb.ts`**: データ永続化層。`idb`ライブラリを使用し、IndexedDBの複雑なAPIをPromiseベースのシンプルな関数（`add`, `get`, `update`等）にカプセル化している。アプリケーションの他の部分はこのモジュールを通じてのみデータベースを操作する。
- **`lib/constants/masters.ts`**: `Transaction` インターフェースを定義し、アプリケーション全体のデータ構造を規定する。また、カテゴリや支払方法のような、コードと名称を対応付けるマスターデータを定数として提供する。
- **`lib/services/settings.svelte.ts`**: Svelte 5の`$state`を利用して、リアクティブなシングルトンサービスを作成。テーマの状態を保持し、変更メソッド（`toggleTheme`）や`localStorage`への永続化ロジックを提供する。
