# 詳細設計書 - 家計簿スマホ入力PWA

## 1. 概要

本アプリケーションは、PC版家計簿システムの補助入力ツールとして設計された、スマートフォンでの利用に最適化されたプログレッシブウェブアプリ（PWA）である。
オフライン環境でも動作し、入力したデータはブラウザ内に永続的に保存される。保存されたデータはCSV形式でエクスポートし、PC版システムに取り込むことが可能。

## 2. 機能一覧

- **PWA対応**: ホーム画面へのインストール、オフライン動作。
- **データ入力**: 収支取引（日付、金額、カテゴリ等）を登録・編集する。
- **データ一覧**: 登録済みの取引を日付の降順で表示し、編集・削除操作を行える。
- **データ出力**: 保存されている全取引データをCSVファイルとしてエクスポートする。
- **入力アシスト**:
  - 収支区分ごとに前回利用したカテゴリ・支払方法を自動セット。
  - 利用頻度の高いカテゴリをチップとして表示し、ワンタップで入力可能。
- **連続入力モード**: 登録後、入力画面を維持しつつ金額のみをリセットし、連続でのデータ入力を支援する。
- **テーマ設定**: ライトモードとダークモードに対応し、手動での切り替えが可能。
- **スワイプナビゲーション**: 画面を左右にスワイプすることで、「入力」「一覧」「出力」の主要画面を切り替えられる。

## 3. 画面仕様

アプリケーションは単一のページで構成され、ヘッダー、タブナビゲーション、コンテンツ領域から成る。

### 3.1. 共通コンポーネント

- **ヘッダー**: アプリケーションタイトルと、テーマ（ライト/ダーク）切り替えボタンを配置。
- **タブナビゲーション**: 「入力」「一覧」「出力」の3つのタブを配置。現在表示中の画面を示す。
- **トースト通知**: データ保存成功時などに、画面下部に一時的なメッセージを表示する。

### 3.2. 入力画面 (`Input.svelte`)

取引データの新規登録または編集を行う画面。

- **入力項目**:
  - 日付 (初期値: 本日)
  - 収支区分 (収入 / 支出)
  - カテゴリ (収支区分に連動)
  - 金額
  - 支払方法 (収支区分に連動)
  - メモ (任意)
  - 未払いフラグ (チェックボックス)
- **アクション**:
  - 「保存」ボタン: 入力内容をDBに保存する。
  - 「キャンセル」ボタン (編集時のみ): 変更を破棄し、一覧画面に戻る。

### 3.3. 一覧画面 (`List.svelte`)

登録済みの取引データを日付の降順にカード形式で表示する。

- **表示項目**:
  - ヘッダー付近: 全データの合計（収入、支出を分けて表示）
  - 各取引カード: 日付、カテゴリ名、メモ、金額、支払方法名
- **アクション (各カード)**:
  - 「編集」ボタン: 対象のデータを入力画面に展開し、編集モードに移行する。
  - 「削除」ボタン: 対象のデータをDBから削除する。

### 3.4. 出力画面 (`Export.svelte`)

- **アクション**:
  - 「CSVダウンロード」ボタン: IndexedDBに保存されている全取引データをCSV形式でファイルに保存する。

## 4. データ構造

### 4.1. データモデル

#### 4.1.1. Transaction (取引データ)

IndexedDBに保存される中心的なデータモデル。

| フィールド名 | 型     | 説明                               |
| :----------- | :----- | :--------------------------------- |
| `id`         | number | プライマリキー (自動インクリメント)|
| `ymd`        | number | 年月日 (例: `20240211`)            |
| `bopCd`      | number | 収支区分コード (1:収入, 2:支出)    |
| `catCd`      | number | カテゴリコード                     |
| `memo`       | string | メモ                               |
| `pmtCd`      | number | 支払方法コード                     |
| `amount`     | number | 金額                               |
| `accruedFlg` | number | 未払いフラグ (0:通常, 1:未払い)    |

#### 4.1.2. マスターデータ (`src/lib/constants/masters.ts`)

- **`BOP_MASTER`**: 収支区分（収入, 支出）のマスター。
- **`CATEGORY_MASTER`**: 収支区分ごとのカテゴリマスター。
- **`PAYMENT_MASTER`**: 収支区分ごとの支払方法マスター。

### 4.2. 永続化データ

#### 4.2.1. IndexedDB

- **データベース名**: `household-db`
- **ストア**:
  - `transactions`: `Transaction` オブジェクトを格納する。
    - **キーパス**: `id`
    - **インデックス**: `by-ymd` (キーパス: `ymd`)。日付での検索に使用。

#### 4.2.2. Local Storage

入力補助機能や設定値を保持するために利用される。

| キー                  | 説明                                       |
| :-------------------- | :----------------------------------------- |
| `theme`               | 現在の表示テーマ ('light' または 'dark')   |
| `lastBop`             | 最後に選択した収支区分コード               |
| `lastCat_[bopCd]`     | 収支区分ごとに最後に選択したカテゴリコード |
| `lastPmt_[bopCd]`     | 収支区分ごとに最後に選択した支払方法コード |
| `catStats_[bopCd]`    | 収支区分ごとのカテゴリ利用頻度統計         |

## 5. 使用技術・ライブラリ

- **フレームワーク**: Svelte 5
- **ビルドツール**: Vite
- **言語**: TypeScript
- **データベース**: IndexedDB
- **DBライブラリ**: `idb` (IndexedDBの軽量ラッパー)
- **PWA**: `vite-plugin-pwa`
